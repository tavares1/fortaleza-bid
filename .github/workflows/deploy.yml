name: Deploy Home Server

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Criar arquivo .env (Segurança via Secrets)
        run: |
          echo "GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }}" > .env
          echo "TWITTER_API_KEY=${{ secrets.TWITTER_API_KEY }}" >> .env
          echo "TWITTER_API_SECRET=${{ secrets.TWITTER_API_SECRET }}" >> .env
          echo "TWITTER_ACCESS_TOKEN=${{ secrets.TWITTER_ACCESS_TOKEN }}" >> .env
          echo "TWITTER_ACCESS_TOKEN_SECRET=${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}" >> .env
          echo "THREADS_USER_ID=${{ secrets.THREADS_USER_ID }}" >> .env
          echo "THREADS_ACCESS_TOKEN=${{ secrets.THREADS_ACCESS_TOKEN }}" >> .env
          echo "CLOUDFLARE_TUNNEL_TOKEN=${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}" >> .env
          # Opcional: Se quiser sobrescrever a data de busca
          # echo "SEARCH_DATE=${{ secrets.SEARCH_DATE }}" >> .env

      - name: Build e Deploy com Docker Compose
        run: |
          # Derruba a versão antiga, reconstrói e sobe a nova
          docker compose down
          docker compose up -d --build
          
      - name: Limpeza de imagens antigas
        run: docker image prune -f
